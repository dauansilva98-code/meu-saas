<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador Financeiro Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        input, select { outline: none; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .btn-primary { background-color: #3b82f6; color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; border: none; cursor: pointer; }
        .btn-primary:hover { background-color: #2563eb; }
        .tabs-container { display: flex; justify-content: center; gap: 1.5rem; border-bottom: 1px solid #e2e8f0; }
        .tab-button { padding: 0.75rem 0.5rem; font-size: 0.875rem; color: #64748b; border-bottom: 2px solid transparent; cursor: pointer; background: none; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 700; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden { display: none; }
        .delete-btn { color: #ef4444; padding: 4px; border-radius: 6px; cursor: pointer; background: transparent; border: none; }
        .delete-btn:hover { background-color: #fee2e2; }
        input[type=range] { cursor: pointer; -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: #e2e8f0; border-radius: 3px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #3b82f6; margin-top: -6px; }
        .toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 8px; padding: 12px; position: fixed; z-index: 100; left: 50%; bottom: 30px; transform: translateX(-50%); opacity: 0; transition: all 0.3s; }
        .toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        .toast-success { background-color: #10b981; }
        .toast-danger { background-color: #ef4444; }
        @media print { .no-print { display: none !important; } }
    </style>
    
    <script>
        if (localStorage.getItem("logado") !== "sim") {
            window.location.href = "login.html";
        }
    </script>
</head>
<body class="pb-12 px-4 md:px-8">
    
    <button onclick="sair()" class="fixed top-5 right-5 bg-red-500 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-red-600 z-50 no-print">
        Sair do Sistema
    </button>

    <div class="max-w-7xl mx-auto pt-6">
        <header class="mb-6 text-center">
            <h1 class="text-2xl font-bold text-slate-800">Organizador Financeiro Pro</h1>
        </header>
        
        <div class="tabs-container mb-6 no-print">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-button tab-active">Planejamento</button>
            <button onclick="switchTab('investments')" id="tab-investments" class="tab-button">Investimentos</button>
            <button onclick="switchTab('history')" id="tab-history" class="tab-button">Histórico</button>
        </div>

        <div id="view-dashboard" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-6">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-xs uppercase text-slate-800">Minhas Rendas</h3>
                        <button onclick="addIncomeRow()" class="text-[10px] btn-primary">+ Adicionar</button>
                    </div>
                    <div id="incomeList" class="space-y-3"></div>
                    <div class="mt-4 pt-3 border-t flex justify-between">
                        <span class="text-xs font-bold text-slate-400">Total:</span>
                        <span id="totalIncomeDisplay" class="text-xl font-black text-emerald-600">R$ 0,00</span>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-xs uppercase text-slate-800">Metas de Gasto (%)</h3>
                        <button onclick="addCategory()" class="text-[10px] btn-primary">+ Meta</button>
                    </div>
                    <div id="expenseSliders" class="space-y-6"></div>
                    <div class="mt-6 pt-4 border-t">
                        <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                            <span>Uso Planejado</span>
                            <span id="totalPercentIndicator">0%</span>
                        </div>
                        <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                            <div id="totalProgressBar" class="h-full bg-blue-500 transition-all" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-xs uppercase text-slate-800">Custo de Vida (Contas)</h3>
                        <button onclick="addBillRow()" class="text-[10px] btn-primary">+ Conta</button>
                    </div>
                    <div id="billsList" class="space-y-4"></div>
                    <div class="mt-6 pt-4 border-t space-y-3">
                        <div class="flex justify-between">
                            <span class="text-xs font-bold text-slate-500">Total Gastos:</span>
                            <span id="totalBillsDisplay" class="text-lg font-bold text-rose-600">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-xs font-bold text-slate-400">Sobrou:</span>
                            <span id="remainingBalanceDisplay" class="text-xl font-black text-emerald-500">R$ 0,00</span>
                        </div>
                        <button onclick="saveMonthToHistory()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold text-xs uppercase hover:bg-blue-700 mt-2">Fechar Mês e Salvar</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-4 space-y-6">
                <div class="card p-6">
                    <h3 class="text-center text-[10px] font-bold text-slate-400 uppercase mb-4">Distribuição</h3>
                    <div class="h-64"><canvas id="financeChart"></canvas></div>
                </div>
                <div class="card p-6">
                    <h3 class="text-xs font-bold uppercase mb-4">Diagnóstico</h3>
                    <div id="diagnoseList" class="space-y-3"></div>
                </div>
            </div>
        </div>

        <div id="view-investments" class="hidden space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-8 card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-xs uppercase">Meus Ativos</h3>
                        <button onclick="addInvestmentRow()" class="text-[10px] btn-primary">+ Novo Ativo</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="text-slate-400 uppercase text-[10px] border-b">
                                <tr><th class="pb-2">Nome</th><th class="pb-2">Banco</th><th class="pb-2">Tipo</th><th class="pb-2 text-right">Valor</th><th></th></tr>
                            </thead>
                            <tbody id="investmentTableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="lg:col-span-4 space-y-6">
                    <div class="card p-6 bg-slate-900 text-white">
                        <div class="mb-4">
                            <h3 class="text-[10px] font-bold uppercase text-slate-400">Reserva de Emergência</h3>
                            <div id="totalOnlyReserveDisplay" class="text-2xl font-black text-blue-400">R$ 0,00</div>
                        </div>
                        <div class="pt-4 border-t border-slate-800">
                            <h3 class="text-[10px] font-bold uppercase text-slate-400">Investimentos</h3>
                            <div id="totalOnlyInvestedDisplay" class="text-2xl font-black text-emerald-400">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-center text-[10px] font-bold text-slate-400 uppercase">Alocação</h3>
                        <div class="h-48"><canvas id="investChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-history" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-5 card p-6">
                <h3 class="font-bold text-blue-600 text-xs uppercase mb-4">Meta da Reserva (6 Meses)</h3>
                <div class="text-2xl font-bold text-slate-700 mb-2" id="reserve6">R$ 0,00</div>
                <div class="flex justify-between text-xs mb-1">
                    <span>Progresso</span>
                    <span id="reserveProgressPercent" class="font-bold text-blue-600">0%</span>
                </div>
                <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
                    <div id="reserveProgressBar" class="h-full bg-blue-500" style="width: 0%"></div>
                </div>
                <p id="reserveMissingLabel" class="text-xs text-rose-500 font-bold mt-2 text-right">Falta: R$ 0,00</p>
            </div>
            <div class="lg:col-span-7 card p-6">
                <h3 class="font-bold text-xs uppercase mb-4">Histórico Mensal</h3>
                <table class="w-full text-left text-xs">
                    <thead class="text-slate-400 uppercase text-[9px] border-b">
                        <tr><th class="py-2">Mês</th><th>Renda</th><th>Gastos</th><th>Sobrou</th><th></th></tr>
                    </thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Mensagem</div>

    <script>
        // =========================================================================
        // 1. CONFIGURAÇÃO DO SUPABASE
        // =========================================================================
        
        // SUA URL JÁ ESTÁ AQUI:
        const supabaseUrl = 'https://izmdjkalwgupuehrbcxm.supabase.co';
        
        // COLE SUA CHAVE (QUE COMEÇA COM 'ey') DENTRO DAS ASPAS ABAIXO:
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6bWRqa2Fsd2d1cHVlaHJiY3htIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNDkwNTUsImV4cCI6MjA4NTgyNTA1NX0.w3FW5oORqiEjT0Xj3d3777KfE0xl2zm0ogezpfN3Gss';

        // Inicialização Segura (Renomeado para evitar conflito)
        let _supabase = null;
        
        try {
            // Usa o objeto global 'supabase' (da biblioteca) para criar o cliente
            if (typeof supabase !== 'undefined') {
                _supabase = supabase.createClient(supabaseUrl, supabaseKey);
                console.log("Supabase iniciado com sucesso.");
            } else {
                console.error("A biblioteca do Supabase não carregou.");
            }
        } catch (e) {
            console.error("Erro nas chaves do Supabase:", e);
        }

        // =========================================================================
        // 2. DADOS E FUNÇÕES
        // =========================================================================

        function generateId() {
            return 'id-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
        }

        const formatCurrency = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);

        // Dados Iniciais
        let incomes = [{ id: generateId(), label: 'Salário', value: 3000 }];
        let categories = [
            { id: 'cat-fix', label: 'Essencial', percent: 50, color: '#3b82f6' },
            { id: 'cat-laz', label: 'Lazer', percent: 30, color: '#ec4899' },
            { id: 'cat-inv', label: 'Investir', percent: 20, color: '#10b981' }
        ];
        let bills = [{ id: generateId(), label: 'Aluguel', value: 1000, categoryId: 'cat-fix' }];
        let investments = [{ id: 'res-id', asset: 'Reserva', institution: 'Nubank', type: 'Reserva', value: 0 }];
        let history = [];
        
        let financeChart, investChart;
        let saveTimeout;

        // --- SALVAMENTO NA NUVEM ---
        async function saveData() {
            if (!_supabase) return;
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;
                
                await _supabase.from('dados_financeiros').upsert({ 
                    id: user.id, 
                    payload: { incomes, categories, bills, investments, history },
                    updated_at: new Date()
                });
                console.log("Dados salvos na nuvem.");
            } catch (err) {
                console.error("Erro ao salvar:", err);
            }
        }

        function triggerSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveData, 2000); 
        }

        async function loadData() {
            if (!_supabase) return;
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;

                const { data } = await _supabase.from('dados_financeiros').select('payload').eq('id', user.id).single();
                
                if (data && data.payload) {
                    const p = data.payload;
                    incomes = p.incomes || incomes;
                    categories = p.categories || categories;
                    bills = p.bills || bills;
                    investments = p.investments || investments;
                    history = p.history || history;
                    
                    updateWholeScreen();
                    showToast("Dados carregados!");
                }
            } catch (err) {
                console.error("Erro ao carregar:", err);
            }
        }

        // --- INTERFACE (UI) ---
        function showToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg;
            t.classList.add("show", "toast-success");
            setTimeout(() => t.classList.remove("show"), 3000);
        }

        function switchTab(tab) {
            ['dashboard', 'investments', 'history'].forEach(t => {
                const view = document.getElementById('view-'+t);
                const btn = document.getElementById('tab-'+t);
                if(view) view.classList.add('hidden');
                if(btn) btn.classList.remove('tab-active');
            });
            const targetView = document.getElementById('view-'+tab);
            const targetBtn = document.getElementById('tab-'+tab);
            if(targetView) targetView.classList.remove('hidden');
            if(targetBtn) targetBtn.classList.add('tab-active');
            
            // Corrige o bug de layout ao trocar de aba desenhando os gráficos novamente
            if(tab === 'dashboard' && financeChart) financeChart.update();
            if(tab === 'investments' && investChart) investChart.update();
            
            updateUI(true);
        }

        function addIncomeRow() { incomes.unshift({ id: generateId(), label: 'Nova Renda', value: 0 }); updateWholeScreen(); triggerSave(); }
        function addBillRow() { bills.unshift({ id: generateId(), label: 'Conta', value: 0, categoryId: categories[0].id }); updateWholeScreen(); triggerSave(); }
        function addInvestmentRow() { investments.unshift({ id: generateId(), asset: '', institution: '', type: 'Renda Fixa', value: 0 }); updateWholeScreen(); triggerSave(); }
        function addCategory() { 
            categories.push({ id: 'cat-'+generateId(), label: 'Meta', percent: 0, color: '#6366f1' }); 
            updateWholeScreen(); triggerSave(); 
        }

        function removeIncome(id) { incomes = incomes.filter(x => x.id !== id); updateWholeScreen(); triggerSave(); }
        function removeBill(id) { bills = bills.filter(x => x.id !== id); updateWholeScreen(); triggerSave(); }
        function removeInvestment(id) { investments = investments.filter(x => x.id !== id); updateWholeScreen(); triggerSave(); }
        function removeCategory(id) { categories = categories.filter(x => x.id !== id); updateWholeScreen(); triggerSave(); }

        function updateIncome(id, f, v) { const i = incomes.find(x => x.id === id); if(i) { i[f] = f === 'value' ? parseFloat(v)||0 : v; updateUI(); triggerSave(); } }
        function updateBill(id, f, v) { const b = bills.find(x => x.id === id); if(b) { b[f] = f === 'value' ? parseFloat(v)||0 : v; updateUI(); triggerSave(); } }
        function updateInvestment(id, f, v) { const i = investments.find(x => x.id === id); if(i) { i[f] = f === 'value' ? parseFloat(v)||0 : v; updateUI(); triggerSave(); } }
        function updateCategoryPerc(id, v) { const c = categories.find(x => x.id === id); if(c) { c.percent = parseInt(v)||0; updateUI(true); triggerSave(); } }
        function updateCategoryLabel(id, v) { 
            const c = categories.find(x => x.id === id); 
            if(c) { 
                c.label = v; 
                if(financeChart) {
                    financeChart.data.labels = categories.map(cat => cat.label);
                    financeChart.update('none');
                }
                triggerSave(); 
            } 
        }

        function renderIncomes() {
            const container = document.getElementById('incomeList');
            if(!container) return;
            container.innerHTML = incomes.map(i => `
                <div class="flex items-center gap-2 bg-slate-50 p-2 rounded border">
                    <input class="flex-1 bg-transparent text-sm" value="${i.label}" oninput="updateIncome('${i.id}', 'label', this.value)">
                    <input class="w-20 text-right font-bold bg-transparent text-sm" type="number" value="${i.value}" oninput="updateIncome('${i.id}', 'value', this.value)">
                    <button onclick="removeIncome('${i.id}')" class="delete-btn"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>`).join('');
        }

        function renderBills() {
            const container = document.getElementById('billsList');
            if(!container) return;
            container.innerHTML = bills.map(b => `
                <div class="bg-slate-50 p-2 rounded border space-y-1">
                    <div class="flex justify-between">
                        <input class="flex-1 bg-transparent text-sm font-medium" value="${b.label}" oninput="updateBill('${b.id}', 'label', this.value)">
                        <input class="w-20 text-right font-bold text-rose-500 bg-transparent text-sm" type="number" value="${b.value}" oninput="updateBill('${b.id}', 'value', this.value)">
                        <button onclick="removeBill('${b.id}')" class="delete-btn"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    <select class="w-full text-[10px] uppercase bg-white border rounded" onchange="updateBill('${b.id}', 'categoryId', this.value)">
                        ${categories.map(c => `<option value="${c.id}" ${b.categoryId===c.id?'selected':''}>${c.label}</option>`).join('')}
                    </select>
                </div>`).join('');
        }

        function renderCategories() {
            const container = document.getElementById('expenseSliders');
            if(!container) return;
            container.innerHTML = categories.map(c => `
                <div>
                    <div class="flex justify-between text-[10px] font-bold uppercase mb-1">
                        <input class="bg-transparent w-24" value="${c.label}" oninput="updateCategoryLabel('${c.id}', this.value)">
                        <div class="flex gap-2">
                            <span id="val-${c.id}" style="color:${c.color}">R$ 0</span>
                            <span style="color:${c.color}">${c.percent}%</span>
                            <button onclick="removeCategory('${c.id}')" class="delete-btn"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                    <input type="range" value="${c.percent}" oninput="updateCategoryPerc('${c.id}', this.value)" style="accent-color:${c.color}">
                </div>`).join('');
        }

        function renderInvestments() {
            const container = document.getElementById('investmentTableBody');
            if(!container) return;
            container.innerHTML = investments.map(i => `
                <tr class="border-b">
                    <td class="py-2"><input class="bg-transparent w-full" value="${i.asset}" oninput="updateInvestment('${i.id}', 'asset', this.value)"></td>
                    <td class="py-2"><input class="bg-transparent w-full" value="${i.institution}" oninput="updateInvestment('${i.id}', 'institution', this.value)"></td>
                    <td class="py-2">
                        <select class="bg-transparent text-[10px] uppercase" onchange="updateInvestment('${i.id}', 'type', this.value)">
                            <option value="Reserva" ${i.type==='Reserva'?'selected':''}>Reserva</option>
                            <option value="Renda Fixa" ${i.type==='Renda Fixa'?'selected':''}>R. Fixa</option>
                            <option value="Renda Variável" ${i.type==='Renda Variável'?'selected':''}>R. Var</option>
                        </select>
                    </td>
                    <td class="py-2 text-right"><input class="w-20 text-right font-bold text-emerald-600 bg-transparent" type="number" value="${i.value}" oninput="updateInvestment('${i.id}', 'value', this.value)"></td>
                    <td class="py-2 text-right">${i.id!=='res-id' ? `<button onclick="removeInvestment('${i.id}')" class="delete-btn ml-auto"><i data-lucide="x" class="w-4 h-4"></i></button>` : ''}</td>
                </tr>`).join('');
        }

        function renderHistory() {
            const container = document.getElementById('historyTableBody');
            if(!container) return;
            container.innerHTML = history.map(h => `
                <tr class="border-b">
                    <td class="py-2 font-bold text-slate-600">${h.date}</td>
                    <td class="py-2 text-emerald-600">${formatCurrency(h.income)}</td>
                    <td class="py-2 text-rose-500">${formatCurrency(h.expenses)}</td>
                    <td class="py-2 font-bold">${formatCurrency(h.income - h.expenses)}</td>
                    <td class="py-2 text-right"><button onclick="history=history.filter(x=>x.id!=='${h.id}');renderHistory();triggerSave()" class="delete-btn ml-auto"><i data-lucide="x" class="w-4 h-4"></i></button></td>
                </tr>`).join('');
        }

        function saveMonthToHistory() {
            const inc = incomes.reduce((a,b)=>a+b.value,0);
            const exp = bills.reduce((a,b)=>a+b.value,0);
            const month = new Date().toLocaleDateString('pt-BR', {month:'short', year:'2-digit'});
            history.unshift({id:generateId(), date:month, income:inc, expenses:exp});
            renderHistory();
            showToast("Mês Salvo!");
            saveData();
        }

        function updateWholeScreen() {
            renderIncomes(); renderBills(); renderCategories(); renderInvestments(); renderHistory();
            if(financeChart) {
                financeChart.data.labels = categories.map(c => c.label);
                financeChart.data.datasets[0].data = categories.map(c => (incomes.reduce((a,b)=>a+b.value,0) * c.percent)/100);
                financeChart.data.datasets[0].backgroundColor = categories.map(c => c.color);
                financeChart.update('none');
            }
            if(investChart) {
                const g = { 'Reserva':0, 'Renda Fixa':0, 'Renda Variável':0 };
                investments.forEach(i => g[i.type] += i.value);
                investChart.data.datasets[0].data = Object.values(g);
                investChart.update('none');
            }
            lucide.createIcons();
            updateUI(true);
        }

        function updateUI(partial = false) {
            const totalInc = incomes.reduce((a,b)=>a+b.value,0);
            const totalExp = bills.reduce((a,b)=>a+b.value,0);
            const totalRes = investments.filter(i=>i.type==='Reserva').reduce((a,b)=>a+b.value,0);
            const totalInv = investments.filter(i=>i.type!=='Reserva').reduce((a,b)=>a+b.value,0);

            document.getElementById('totalIncomeDisplay').innerText = formatCurrency(totalInc);
            document.getElementById('totalBillsDisplay').innerText = formatCurrency(totalExp);
            
            const rem = totalInc - totalExp;
            const remEl = document.getElementById('remainingBalanceDisplay');
            if(remEl) {
                remEl.innerText = formatCurrency(rem);
                remEl.className = `text-xl font-black ${rem<0?'text-rose-600':'text-emerald-500'}`;
            }

            document.getElementById('totalOnlyReserveDisplay').innerText = formatCurrency(totalRes);
            document.getElementById('totalOnlyInvestedDisplay').innerText = formatCurrency(totalInv);

            const totalPerc = categories.reduce((a,b)=>a+b.percent,0);
            document.getElementById('totalPercentIndicator').innerText = totalPerc + '%';
            document.getElementById('totalProgressBar').style.width = Math.min(100, totalPerc) + '%';
            document.getElementById('totalProgressBar').className = `h-full transition-all ${totalPerc>100?'bg-rose-500':'bg-blue-500'}`;

            const meta12 = totalExp * 12;
            const prog = meta12 > 0 ? (totalRes/meta12)*100 : 0;
            const missing = Math.max(0, meta12 - totalRes);
            document.getElementById('reserve6').innerText = formatCurrency(totalExp * 6);
            document.getElementById('reserveProgressPercent').innerText = Math.round(prog) + '%';
            document.getElementById('reserveProgressBar').style.width = Math.min(100, prog) + '%';
            
            const missingLabel = document.getElementById('reserveMissingLabel');
            if(missingLabel) missingLabel.innerText = missing > 0 ? `Falta: ${formatCurrency(missing)}` : "Concluído!";

            const diagList = document.getElementById('diagnoseList');
            if(diagList) {
                diagList.innerHTML = categories.map(c => {
                    const target = (totalInc * c.percent)/100;
                    const actual = bills.filter(b=>b.categoryId===c.id).reduce((a,b)=>a+b.value,0);
                    const isOver = actual > target;
                    
                    const valEl = document.getElementById(`val-${c.id}`);
                    if(valEl) valEl.innerText = formatCurrency(target);
                    
                    return `<div class="p-2 rounded border ${isOver?'bg-rose-50 border-rose-200':'bg-emerald-50 border-emerald-200'}">
                        <div class="flex justify-between text-[10px] font-bold uppercase">
                            <span>${c.label}</span><span>${isOver?'⚠️':'✅'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>${Math.round((actual/(target||1))*100)}%</span>
                            <span class="opacity-70">${formatCurrency(actual)} / ${formatCurrency(target)}</span>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        window.onload = () => {
            const ctx1 = document.getElementById('financeChart');
            if(ctx1) {
                financeChart = new Chart(ctx1.getContext('2d'), { type: 'doughnut', data: {labels:[], datasets:[{data:[], borderWidth:0}]}, options: {cutout:'70%', plugins:{legend:{display:false}}} });
            }
            
            const ctx2 = document.getElementById('investChart');
            if(ctx2) {
                investChart = new Chart(ctx2.getContext('2d'), { type: 'pie', data: {labels:['Reserva','Fixa','Var'], datasets:[{data:[0,0,0], backgroundColor:['#3b82f6','#10b981','#f59e0b'], borderWidth:0}]}, options: {plugins:{legend:{display:false}}} });
            }
            
            updateWholeScreen();
            loadData();
        };

        function sair() {
            localStorage.removeItem("logado");
            window.location.href = "login.html";
        }
    </script>
</body>
</html>