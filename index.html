<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador Financeiro Pro - Nuvem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; }
        .btn-primary { background-color: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; }
        .toast { visibility: hidden; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 1000; transition: 0.3s; }
        .toast.show { visibility: visible; bottom: 50px; }
    </style>
</head>
<body class="pb-12 px-4 md:px-8">

    <div class="max-w-7xl mx-auto mt-6">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-slate-800">Organizador Pro <span class="text-blue-500">Cloud</span></h1>
            <div class="flex gap-2">
                <button onclick="saveData()" class="bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-bold">Salvar Agora</button>
                <button onclick="sair()" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold">Sair</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 space-y-6">
                <div class="card">
                    <h3 class="font-bold mb-4 text-xs uppercase text-slate-400">Rendas</h3>
                    <div id="incomeList" class="space-y-2 mb-4"></div>
                    <button onclick="addIncomeRow()" class="w-full text-blue-500 text-xs font-bold">+ Adicionar Renda</button>
                </div>

                <div class="card bg-slate-900 text-white">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Reserva de Emergência</h3>
                    <input type="number" id="reservaInput" onchange="updateReserva(this.value)" class="bg-transparent text-2xl font-black text-blue-400 w-full outline-none" value="0">
                    <p class="text-[10px] text-slate-500 mt-2">Altere o valor acima para atualizar a nuvem.</p>
                </div>
            </div>

            <div class="lg:col-span-4 card flex flex-col items-center justify-center">
                <h3 class="font-bold mb-4 text-xs uppercase text-slate-400">Distribuição</h3>
                <div class="w-full h-64">
                    <canvas id="financeChart"></canvas>
                </div>
            </div>

            <div class="lg:col-span-4 card">
                <h3 class="font-bold mb-4 text-xs uppercase text-slate-400">Contas / Gastos</h3>
                <div id="billsList" class="space-y-2 mb-4"></div>
                <button onclick="addBillRow()" class="w-full text-blue-500 text-xs font-bold">+ Adicionar Conta</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Sincronizando...</div>

    <script>
        // --- 1. CONFIGURAÇÃO (Troque pelos seus dados) ---
        const _supabaseUrl = 'https://izmdjkalwgupuehrbcxm.supabase.co'; 
        const _supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6bWRqa2Fsd2d1cHVlaHJiY3htIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNDkwNTUsImV4cCI6MjA4NTgyNTA1NX0.w3FW5oORqiEjT0Xj3d3777KfE0xl2zm0ogezpfN3Gss';
        const supabase = supabase.createClient(_supabaseUrl, _supabaseKey);

        // --- 2. ESTADO DOS DADOS ---
        let incomes = [];
        let bills = [];
        let reservaEmergencia = 0;
        let financeChart;

        // --- 3. FUNÇÕES DA NUVEM ---

        async function saveData() {
            showToast("Salvando na nuvem...");
            const payload = {
                incomes,
                bills,
                reservaEmergencia
            };

            const { error } = await supabase
                .from('projetos, notas')
                .insert([{ "dados preenchidos": JSON.stringify(payload) }]);

            if (error) {
                console.error(error);
                showToast("Erro ao salvar!", "red");
            } else {
                showToast("Tudo salvo e sincronizado!");
            }
        }

        async function loadData() {
            const { data, error } = await supabase
                .from('projetos, notas')
                .select('dados preenchidos')
                .order('created_at', { ascending: false })
                .limit(1);

            if (data && data.length > 0) {
                const db = JSON.parse(data[0]["dados preenchidos"]);
                incomes = db.incomes || [];
                bills = db.bills || [];
                reservaEmergencia = db.reservaEmergencia || 0;
                
                document.getElementById('reservaInput').value = reservaEmergencia;
                renderAll();
            }
        }

        // --- 4. LÓGICA DO APP ---

        function updateReserva(val) {
            reservaEmergencia = parseFloat(val) || 0;
            updateChart();
            saveData();
        }

        function addIncomeRow() {
            incomes.push({ id: Date.now(), label: 'Nova Renda', value: 0 });
            renderAll();
            saveData();
        }

        function addBillRow() {
            bills.push({ id: Date.now(), label: 'Nova Conta', value: 0 });
            renderAll();
            saveData();
        }

        function renderAll() {
            // Render Rendas
            document.getElementById('incomeList').innerHTML = incomes.map(i => `
                <div class="flex justify-between border-b pb-1">
                    <input class="text-sm w-full" value="${i.label}" onchange="updateItem(incomes, ${i.id}, 'label', this.value)">
                    <input class="text-sm font-bold w-20 text-right" value="${i.value}" onchange="updateItem(incomes, ${i.id}, 'value', this.value)">
                </div>
            `).join('');

            // Render Contas
            document.getElementById('billsList').innerHTML = bills.map(b => `
                <div class="flex justify-between border-b pb-1 text-rose-600">
                    <input class="text-sm w-full" value="${b.label}" onchange="updateItem(bills, ${b.id}, 'label', this.value)">
                    <input class="text-sm font-bold w-20 text-right" value="${b.value}" onchange="updateItem(bills, ${b.id}, 'value', this.value)">
                </div>
            `).join('');

            updateChart();
        }

        function updateItem(arr, id, field, val) {
            const item = arr.find(x => x.id === id);
            if(item) {
                item[field] = field === 'value' ? parseFloat(val) : val;
                updateChart();
                saveData();
            }
        }

        // --- 5. O GRÁFICO ---
        function updateChart() {
            const totalIncomes = incomes.reduce((a, b) => a + b.value, 0);
            const totalBills = bills.reduce((a, b) => a + b.value, 0);
            const data = [totalIncomes, totalBills, reservaEmergencia];

            if (financeChart) {
                financeChart.data.datasets[0].data = data;
                financeChart.update();
            } else {
                const ctx = document.getElementById('financeChart').getContext('2d');
                financeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Rendas', 'Gastos', 'Reserva'],
                        datasets: [{
                            data: data,
                            backgroundColor: ['#10b981', '#ef4444', '#3b82f6']
                        }]
                    },
                    options: { maintainAspectRatio: false }
                });
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function sair() {
            localStorage.clear();
            window.location.href = "login.html";
        }

        window.onload = loadData;
    </script>
</body>
</html>